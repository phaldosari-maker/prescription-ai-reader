import streamlit as st
import base64
from openai import OpenAI

# --- ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ ---
st.set_page_config(page_title="ูุญูู ุงููุตูุงุช ุงูุทุจูุฉ AI", layout="centered")

# --- ุงูุนููุงู ูุงูููุฏูุฉ ---
st.title("๐ฉบ ูุงุฑุฆ ุงููุตูุงุช ุงูุทุจูุฉ ุงูุฐูู")
st.write("ูู ุจุฑูุน ุตูุฑุฉ ุงููุตูุฉ ุงูุทุจูุฉุ ูุณูููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุจุงุณุชุฎุฑุงุฌ ุฃุณูุงุก ุงูุฃุฏููุฉ ูุงูุฌุฑุนุงุช.")

# --- ุฅุฏุฎุงู ููุชุงุญ ุงูู API (ููุญูุงูุฉ ูุง ูุถุนู ูู ุงูููุฏ ูุจุงุดุฑุฉ) ---
api_key = st.text_input("ุฃุฏุฎู ููุชุงุญ OpenAI API ุงูุฎุงุต ุจู:", type="password")

# --- ุฏุงูุฉ ูุชุญููู ุงูุตูุฑุฉ ููููููุง ุงูุฐูุงุก ุงูุงุตุทูุงุนู ---
def encode_image(image_file):
    return base64.b64encode(image_file.getvalue()).decode('utf-8')

# --- ุฏุงูุฉ ุชุญููู ุงููุตูุฉ ---
def analyze_prescription(api_key, image_base64):
    client = OpenAI(api_key=api_key)
    
    prompt_text = """
    ุฃูุช ูุณุงุนุฏ ุตูุฏูู ุฎุจูุฑ. ูููุชู ูู ุงููุธุฑ ุฅูู ุตูุฑุฉ ูุฐู ุงููุตูุฉ ุงูุทุจูุฉ ูุงุณุชุฎุฑุงุฌ ุงููุนูููุงุช ุงูุชุงููุฉ ุจุฏูุฉ:
    1. ุงุณู ุงูุทุจูุจ (ุฅู ูุฌุฏ).
    2. ุงุณู ุงููุฑูุถ (ุฅู ูุฌุฏ).
    3. ูุงุฆูุฉ ุจุงูุฃุฏููุฉ ุงูููุชูุจุฉุ ูุน ุงูุฌุฑุนุฉ ูุทุฑููุฉ ุงูุงุณุชุฎุฏุงู ููู ุฏูุงุก.
    
    ููุงุญุธุฉ ูุงูุฉ:
    - ุฅุฐุง ูุงู ุงูุฎุท ุบูุฑ ูุงุถุญุ ุญุงูู ุงุณุชูุชุงุฌ ุงูุฏูุงุก ุจูุงุกู ุนูู ุงูุณูุงู ุงูุทุจู ุงูุตุญูุญ.
    - ูู ุจุชุฑุฌูุฉ ุงูุชุนูููุงุช (ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู) ุฅูู ุงููุบุฉ ุงูุนุฑุจูุฉ ูุชููู ูุงุถุญุฉ ูููุฑูุถ.
    - ุงุนุฑุถ ุงููุชูุฌุฉ ูู ุฌุฏูู ููุธู.
    """

    try:
        response = client.chat.completions.create(
            model="gpt-4o",  # ูุณุชุฎุฏู ุงูููุฏูู ุงูุฃููู ููุตูุฑ
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt_text},
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{image_base64}"
                            },
                        },
                    ],
                }
            ],
            max_tokens=1000,
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู: {e}"

# --- ูุงุฌูุฉ ุฑูุน ุงูุตูุฑุฉ ---
uploaded_file = st.file_uploader("ุงุฑูุน ุตูุฑุฉ ุงููุตูุฉ ููุง (JPG, PNG)", type=["jpg", "png", "jpeg"])

if uploaded_file is not None:
    # ุนุฑุถ ุงูุตูุฑุฉ ูููุณุชุฎุฏู
    st.image(uploaded_file, caption='ุงููุตูุฉ ุงููุฑููุฉ', use_column_width=True)
    
    if st.button("๐ ุชุญููู ุงููุตูุฉ ุงูุขู"):
        if not api_key:
            st.error("ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุชุงุญ API ุฃููุงู ููุนูู.")
        else:
            with st.spinner('ุฌุงุฑู ูุฑุงุกุฉ ุฎุท ุงูุทุจูุจ ูุชุญููู ุงูุจูุงูุงุช...'):
                # ุชุญููู ุงูุตูุฑุฉ
                base64_image = encode_image(uploaded_file)
                # ุฅุฑุณุงู ููุฐูุงุก ุงูุงุตุทูุงุนู
                result = analyze_prescription(api_key, base64_image)
                
                # ุนุฑุถ ุงููุชูุฌุฉ
                st.success("ุชู ุงูุชุญููู ุจูุฌุงุญ!")
                st.markdown("### ๐ ูุชูุฌุฉ ุงููุฑุงุกุฉ:")
                st.markdown(result)
                
                st.warning("โ๏ธ ุชูุจูู: ูุฐู ูุฑุงุกุฉ ุขููุฉ ููุฏ ุชุญุชูู ุงูุฎุทุฃ. ูุฑุฌู ูุฑุงุฌุนุฉ ุงูุตูุฏูู ุงููุฎุชุต ูุจู ุตุฑู ุงูุฏูุงุก.")

# --- ุชุฐููู ุงููููุน ---
st.markdown("---")
st.caption("ุชู ุชุทููุฑ ูุฐุง ุงููุธุงู ููุซุงู ุชููู ุจุงุณุชุฎุฏุงู GPT-4o Vision & Streamlit")
